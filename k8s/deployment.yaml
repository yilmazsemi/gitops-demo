apiVersion: apps/v1  # Deployment API sürümü
kind: Deployment  # Kaynak türü
metadata:
  namespace: default  # Deployment'ın namespace'i
  name: gitops-demo-deployment  # Deployment adı
  labels:
    app: gitops-demo  # Deployment label
spec:
  replicas: 3  # Pod sayısı
  selector:
    matchLabels:
      app: gitops-demo  # Hangi pod'lara ait olduğunu belirler

  # ❌ 6) LABEL MISMATCH → Pod'lar bu Deployment tarafından yönetilemez
  # Deployment app=gitops-demo arıyor ama pod template app=gitops-demo-broken
  # ReplicaSet pod bulamayacağı için ArgoCD Health DEGRADE olur
  template:
    metadata:
      namespace: default
      labels:
        app: gitops-demo-broken  # intentionally broken label (normalde gitops-demo olmalı)

    spec:
      containers:
        - name: gitops-demo  # Container adı

          # ❌ 1) Broken image → intentionally wrong tag
          # Bu image mevcut değil → ImagePullBackOff → pod'lar başlatılamaz
          image: yilmazsemi/gitops-demo:broken-latest

          # ❌ 2) Root user → ciddi güvenlik açığı
          securityContext:
            runAsUser: 0  # root olarak çalıştırmak büyük risk

            # ❌ 3) Privilege escalation → host üzerinde daha fazla yetki alınabilir
            allowPrivilegeEscalation: true

            # ❌ 4) Dosya sistemi yazılabilir → saldırgan içeride dosya manipüle edebilir
            readOnlyRootFilesystem: false

            # ❌ 5) SYS_ADMIN capability → container neredeyse host-level yetki alır
            capabilities:
              add:
                - SYS_ADMIN

          ports:
            - containerPort: 3000  # Container portu

          # ❌ 7) Sensitive plaintext secrets → büyük güvenlik riski
          env:
            - name: SECRET_KEY
              value: "123456"  # normalde secret olarak tutulmalı

          # ❌ 8) Broken readiness probe → Pod hiçbir zaman ready olmaz
          # ArgoCD Health: Degraded olur
          readinessProbe:
            httpGet:
              path: /healthz
              port: 9999  # intentionally wrong port
            initialDelaySeconds: 3
            periodSeconds: 5

          # ❌ 9) Absürt kaynak değerleri → pod schedule edilemeyebilir
          resources:
            requests:
              memory: "1Mi"   # aşırı düşük → scheduler reddedebilir
              cpu: "1m"
            limits:
              memory: "10Gi"  # aşırı yüksek → node kaldırmaz
              cpu: "8"        # çoğu cluster için çok yüksek
